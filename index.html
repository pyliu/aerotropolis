<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="For Aviation City use only">
    <meta name="author" content="LIU, PANG-YU">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="cache-control" content="no-cache">
    <title>桃園市地政局航空城開發科</title>
    <!-- Bootstrap core CSS -->
    <link rel="preload" href="assets/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/loading.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/loading-btn.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/animate.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/awesome-font.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/bootstrap-vue.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/starter-template.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="assets/css/transition.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <style type="text/css">
    a:hover {
        text-decoration: none;
    }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="index.html"><i class="fa fa-search fa-lg"></i> 地籍整理清冊搜尋</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault"
            aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="admin.html""><i class=" fa fa-database fa-fw"></i> 更新資料庫</a>
                </li>
            </ul>
        </div>
        <h5 class="text-light my-auto"><i class="fas fa-plane-departure"></i> 航空城開發科</h5>
    </nav>

    <main role="main" class="container">
        <div id="vueApp"></div>
        <div id="footer"></div>
    </main><!-- /.container -->

    <!-- Place scripts at the end of the body to let DOM load first then scripts  -->
    <!-- Bootstrap core JavaScript -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- Vue -->
    <script src="assets/js/vue.js"></script>
    <script src="assets/js/vuex.js"></script>
    <script src="assets/js/bootstrap-vue.min.js"></script>
    <script src="assets/js/bootstrap-vue-icons.min.js"></script>
    <!-- Add-On -->
    <script src="assets/js/axios.min.js"></script>
    <script src="assets/js/localforage.min.js"></script>
    <script>
        const vueApp = new Vue({
            el: '#vueApp',
            template: `<b-container fluid>
                <b-input-group prepend="歸戶號或統編" class="my-3">
                    <b-popover target="popover-target-1" triggers="hover" placement="top">
                        <span>範例：機1-00003 / 附07-000150 / A123456789 / 0000000158 / *HE0173840</span>
                    </b-popover>
                    <b-form-input ref="keyword" id="popover-target-1" v-model="keyword" :state="validate" @keyup.enter="search"></b-form-input>
                    <b-input-group-append>
                        <b-button variant="primary" @click="search" :disabled="wip"><i class="fas fa-search"></i> 搜尋</b-button>
                    </b-input-group-append>
                </b-input-group>
                <transition name="slide-fade" mode="out-in">
                    <div v-if="searchCount > 0">
                        <div class="text-muted text-right">找到 {{searchCount}} 筆資料</div>
                        <b-list-group flush compact>
                            <b-list-group-item v-for="row in searchResults" class="d-flex justify-content-between">
                                <b-link @click="quickSearch(row['household'])">{{row['household']}}</b-link>
                                <b-link @click="quickSearch(row['pid'])">{{row['pid']}}</b-link>
                                <b-link @click="quickSearch(row['pname'])">{{row['pname']}}</b-link>
                                <b-link @click="quickSearch(row['owned_number'])">
                                    {{row['owned_number'].slice(0, 4)}}-{{row['owned_number'].slice(4)}}
                                    <i class="far fa-share-square text-danger" @click.stop="query(row['owned_number'])" title="開啟地籍資料視窗"></i>
                                </b-link>
                            </b-list-group-item>
                        </b-list-group>
                    </div>
                    <h4 v-else class="text-center text-muted"><i class="fas fa-exclamation-circle"></i> 查無資料。</h4>
                </transition>
                <b-modal
                    ref="modal"
                    size="lg"
                    title="地籍資料"
                    no-close-on-backdrop
                    ok-title="確認"
                    ok-only
                >
                    <div v-html="landData"></div>
                </b-modal>
            </b-container>`,
            data: () => ({
                keyword: '',
                wip: false,
                searchResults: [],
                searchCount: 0,
                landData: undefined,
                footer: true
            }),
            computed: {
                validate() {
                            // 附07-000771 機1-00001
                    return (/^(附\d{2}\-\d{6})|(機\d{1}\-\d{5})$/.test(this.keyword) ||
                            // 統編
                            /^[A-Z]{1}[1-2]{1}[0-9]{8}$/.test(this.keyword) ||
                            // dead
                            /^\*H[A-H]\d{7}$/.test(this.keyword) ||
                            // 法人公司行號統編
                            /^\d{8}|\d{10}$/.test(this.keyword) ||
                            // 外國人
                            /^\d{8}|[A-Z]{2}$/.test(this.keyword) ||
                            // 段地號
                            /^0\d{11}$/.test(this.keyword)) && this.keyword.length < 13 && this.keyword.length !== 9
                }
            },
            methods: {
                quickSearch(data) {
                    this.keyword = data;
                    this.search();
                },
                search() {
                    if (!this.wip) {
                        this.wip = true;
                        this.searchResults = [];
                        this.searchCount = 0;
                        let formData = new FormData();
                        formData.append("keyword", this.keyword);
                        axios.post("api/search.php", formData).then((res) => {
                            this.searchResults = res.data.results;
                            this.searchCount = res.data.count;
                        }).catch((err) => console.error(err)).finally(() => { this.wip = false; });
                    }
                },
                query(landNumber) {
                    this.wip = true;
                    let formData = new FormData();
                    formData.append("owned_number", landNumber);
                    axios.post("api/query_land_data.php", formData).then((res) => {
                        // console.log(res.data);
                        this.landData = res.data.result[0].content.trim().replace(/\n/g, '<br />');
                        this.$refs.modal.show();
                    }).catch((err) => console.error(err)).finally(() => { this.wip = false; });
                }
            },
            mounted() {
                setTimeout(() => {
                    this.footer = false;
                }, 10000);
            }
        });
        const vueFooter = new Vue({
            el: '#footer',
            template: `<transition>
                <p v-if="show" class="text-muted fixed-bottom my-2 mx-3 bg-white border rounded text-center p-2 small shadow">
                <span>
                    <a href="https://github.com/pyliu/aerotropolis" target="_blank" title="View project on Github!">
                        <i class="fab fa-github fa-lg text-dark"></i>
                    </a>
                    <strong><i class="far fa-copyright"></i> <a href="mailto:pangyu.liu@gmail.com">LIU, PANG-YU</a> ALL RIGHTS RESERVED.</strong>
                    <a href="https://vuejs.org/" target="_blank" title="Learn Vue JS!">
                        <i class="text-success fab fa-vuejs fa-lg"></i>
                    </a>
                </span>
                </p>
            </transition>`,
            data: () => ({
                show: true
            }),
            mounted() {
                setTimeout(() => this.show = false, 10000);
            }
        });
    </script>
</body>

</html>